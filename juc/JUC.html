<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.61" />
    <meta name="theme" content="VuePress Theme Hope" />
    <meta property="og:url" content="https://littlebai118.github.io/juc/JUC.html"><meta property="og:site_name" content="白先生"><meta property="og:title" content="JUC——Java并发编程"><meta property="og:description" content="进程与线程 进程 程序由指令和数据组成，但这些指令要运行，数据要读写，就必须将指令加载至CPU，数据加载至内存。在指令运行过程中还需要用到磁盘、网络等设备。进程就是用来加载指令、管理内存、管理IO的。当一个程序被运行，从磁盘加载这个程序的代码至内存，这时就开启了一个进程。 进程就可以视为程序的一个实例。大部分程序可以同时运行多个实例进程（例如记事本、画图、浏览器等)，也有的程序只能启动一个实例进程（例如网易云音乐、360安全卫士等)。 线程 一个进程之内可以分为一到多个线程。 一个线程就是一个指令流，将指令流中的一条条指令以一定的顺序交给CPU执行 Java中，线程作为最小调度单位，进程作为资源分配的最小单位。在windows 中进程是不活动的，只是作为线程的容器。"><meta property="og:type" content="article"><meta property="og:image" content="https://littlebai118.github.io/"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2023-05-15T03:21:09.000Z"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image:alt" content="JUC——Java并发编程"><meta property="article:tag" content="JUC"><meta property="article:published_time" content="2023-05-15T11:20:49.000Z"><meta property="article:modified_time" content="2023-05-15T03:21:09.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"JUC——Java并发编程","image":["https://littlebai118.github.io/"],"datePublished":"2023-05-15T11:20:49.000Z","dateModified":"2023-05-15T03:21:09.000Z","author":[]}</script><title>JUC——Java并发编程 | 白先生</title><meta name="description" content="进程与线程 进程 程序由指令和数据组成，但这些指令要运行，数据要读写，就必须将指令加载至CPU，数据加载至内存。在指令运行过程中还需要用到磁盘、网络等设备。进程就是用来加载指令、管理内存、管理IO的。当一个程序被运行，从磁盘加载这个程序的代码至内存，这时就开启了一个进程。 进程就可以视为程序的一个实例。大部分程序可以同时运行多个实例进程（例如记事本、画图、浏览器等)，也有的程序只能启动一个实例进程（例如网易云音乐、360安全卫士等)。 线程 一个进程之内可以分为一到多个线程。 一个线程就是一个指令流，将指令流中的一条条指令以一定的顺序交给CPU执行 Java中，线程作为最小调度单位，进程作为资源分配的最小单位。在windows 中进程是不活动的，只是作为线程的容器。">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d1e1f;
      }

      html,
      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="preload" href="/assets/style-5a998e47.css" as="style"><link rel="stylesheet" href="/assets/style-5a998e47.css">
    <link rel="modulepreload" href="/assets/app-96b52a23.js"><link rel="modulepreload" href="/assets/framework-a045178c.js"><link rel="modulepreload" href="/assets/JUC.html-b5cc55f9.js"><link rel="modulepreload" href="/assets/JUC.html-f339b647.js"><link rel="prefetch" href="/assets/index.html-a52af3f5.js" as="script"><link rel="prefetch" href="/assets/intro.html-b77fea81.js" as="script"><link rel="prefetch" href="/assets/JVM.html-eacf0743.js" as="script"><link rel="prefetch" href="/assets/MySQL.html-4988849c.js" as="script"><link rel="prefetch" href="/assets/SpringBoot配置文件.html-8fd2538f.js" as="script"><link rel="prefetch" href="/assets/spring-boot-maven-plugin有什么用.html-42e7952d.js" as="script"><link rel="prefetch" href="/assets/接口冲突了怎么办.html-61d1909f.js" as="script"><link rel="prefetch" href="/assets/西昌.html-8f6281bc.js" as="script"><link rel="prefetch" href="/assets/JMM.html-33873e8d.js" as="script"><link rel="prefetch" href="/assets/Java中四种主要的IO模型.html-b836deb5.js" as="script"><link rel="prefetch" href="/assets/类中各种代码块的执行顺序：静态代码块、构造代码块、构造方法.html-63a9180e.js" as="script"><link rel="prefetch" href="/assets/转发与重定向.html-d039e311.js" as="script"><link rel="prefetch" href="/assets/404.html-a8fec6ce.js" as="script"><link rel="prefetch" href="/assets/index.html-43409506.js" as="script"><link rel="prefetch" href="/assets/index.html-3e490e84.js" as="script"><link rel="prefetch" href="/assets/index.html-a7828661.js" as="script"><link rel="prefetch" href="/assets/index.html-02545a57.js" as="script"><link rel="prefetch" href="/assets/index.html-c7dbe816.js" as="script"><link rel="prefetch" href="/assets/index.html-a0306b75.js" as="script"><link rel="prefetch" href="/assets/index.html-563e1791.js" as="script"><link rel="prefetch" href="/assets/index.html-999c9cb4.js" as="script"><link rel="prefetch" href="/assets/index.html-006c4e74.js" as="script"><link rel="prefetch" href="/assets/index.html-cc292b2d.js" as="script"><link rel="prefetch" href="/assets/index.html-6e9a0432.js" as="script"><link rel="prefetch" href="/assets/index.html-2042131f.js" as="script"><link rel="prefetch" href="/assets/index.html-6b616927.js" as="script"><link rel="prefetch" href="/assets/index.html-60b6ff3c.js" as="script"><link rel="prefetch" href="/assets/index.html-e2b85f59.js" as="script"><link rel="prefetch" href="/assets/index.html-e9a0fa2e.js" as="script"><link rel="prefetch" href="/assets/index.html-e278b67c.js" as="script"><link rel="prefetch" href="/assets/index.html-d9d9dc71.js" as="script"><link rel="prefetch" href="/assets/index.html-e9e7f20a.js" as="script"><link rel="prefetch" href="/assets/index.html-3735631a.js" as="script"><link rel="prefetch" href="/assets/index.html-89872fd2.js" as="script"><link rel="prefetch" href="/assets/index.html-f76b239b.js" as="script"><link rel="prefetch" href="/assets/index.html-fe86087a.js" as="script"><link rel="prefetch" href="/assets/index.html-1fd2ddfd.js" as="script"><link rel="prefetch" href="/assets/index.html-ea3e581c.js" as="script"><link rel="prefetch" href="/assets/index.html-9b16ed26.js" as="script"><link rel="prefetch" href="/assets/index.html-a1181155.js" as="script"><link rel="prefetch" href="/assets/index.html-1726ee8b.js" as="script"><link rel="prefetch" href="/assets/index.html-72ca71db.js" as="script"><link rel="prefetch" href="/assets/index.html-c71d6f39.js" as="script"><link rel="prefetch" href="/assets/index.html-a3b7a682.js" as="script"><link rel="prefetch" href="/assets/index.html-00a6bd29.js" as="script"><link rel="prefetch" href="/assets/index.html-91535ba8.js" as="script"><link rel="prefetch" href="/assets/intro.html-1f278660.js" as="script"><link rel="prefetch" href="/assets/JVM.html-fa31e522.js" as="script"><link rel="prefetch" href="/assets/MySQL.html-c8b2d83f.js" as="script"><link rel="prefetch" href="/assets/SpringBoot配置文件.html-1a86133c.js" as="script"><link rel="prefetch" href="/assets/spring-boot-maven-plugin有什么用.html-23b4e3c3.js" as="script"><link rel="prefetch" href="/assets/接口冲突了怎么办.html-832975a9.js" as="script"><link rel="prefetch" href="/assets/西昌.html-fca953d0.js" as="script"><link rel="prefetch" href="/assets/JMM.html-57bc0c04.js" as="script"><link rel="prefetch" href="/assets/Java中四种主要的IO模型.html-ce6a1fca.js" as="script"><link rel="prefetch" href="/assets/类中各种代码块的执行顺序：静态代码块、构造代码块、构造方法.html-45d5caa3.js" as="script"><link rel="prefetch" href="/assets/转发与重定向.html-8773c79b.js" as="script"><link rel="prefetch" href="/assets/404.html-8dc761d7.js" as="script"><link rel="prefetch" href="/assets/index.html-483faaac.js" as="script"><link rel="prefetch" href="/assets/index.html-c7336fe7.js" as="script"><link rel="prefetch" href="/assets/index.html-9d4d2257.js" as="script"><link rel="prefetch" href="/assets/index.html-76c6199c.js" as="script"><link rel="prefetch" href="/assets/index.html-288a0bbe.js" as="script"><link rel="prefetch" href="/assets/index.html-beda6c83.js" as="script"><link rel="prefetch" href="/assets/index.html-af0b6faf.js" as="script"><link rel="prefetch" href="/assets/index.html-80c12cff.js" as="script"><link rel="prefetch" href="/assets/index.html-ad3096ed.js" as="script"><link rel="prefetch" href="/assets/index.html-cc29ea18.js" as="script"><link rel="prefetch" href="/assets/index.html-5c748056.js" as="script"><link rel="prefetch" href="/assets/index.html-c0e11f76.js" as="script"><link rel="prefetch" href="/assets/index.html-2138fc86.js" as="script"><link rel="prefetch" href="/assets/index.html-1f50686c.js" as="script"><link rel="prefetch" href="/assets/index.html-eb177e9d.js" as="script"><link rel="prefetch" href="/assets/index.html-2b95b49a.js" as="script"><link rel="prefetch" href="/assets/index.html-1c3dbc7b.js" as="script"><link rel="prefetch" href="/assets/index.html-ff5d6f16.js" as="script"><link rel="prefetch" href="/assets/index.html-4a83d0d7.js" as="script"><link rel="prefetch" href="/assets/index.html-834a993e.js" as="script"><link rel="prefetch" href="/assets/index.html-a5eb2981.js" as="script"><link rel="prefetch" href="/assets/index.html-0b971ce2.js" as="script"><link rel="prefetch" href="/assets/index.html-190287ce.js" as="script"><link rel="prefetch" href="/assets/index.html-ac0b7b29.js" as="script"><link rel="prefetch" href="/assets/index.html-96c21f95.js" as="script"><link rel="prefetch" href="/assets/index.html-7f79780b.js" as="script"><link rel="prefetch" href="/assets/index.html-908cc129.js" as="script"><link rel="prefetch" href="/assets/index.html-78162f4e.js" as="script"><link rel="prefetch" href="/assets/index.html-5a4f4e2f.js" as="script"><link rel="prefetch" href="/assets/index.html-826cfc94.js" as="script"><link rel="prefetch" href="/assets/index.html-6c105886.js" as="script"><link rel="prefetch" href="/assets/index.html-cbda40ba.js" as="script"><link rel="prefetch" href="/assets/auto-ba5ecab5.js" as="script"><link rel="prefetch" href="/assets/index-8764208e.js" as="script"><link rel="prefetch" href="/assets/flowchart-35969cab.js" as="script"><link rel="prefetch" href="/assets/mermaid.core-d4b02c00.js" as="script"><link rel="prefetch" href="/assets/highlight.esm-a794bb63.js" as="script"><link rel="prefetch" href="/assets/markdown.esm-d92a2fc9.js" as="script"><link rel="prefetch" href="/assets/math.esm-70a288c8.js" as="script"><link rel="prefetch" href="/assets/notes.esm-224f94d9.js" as="script"><link rel="prefetch" href="/assets/reveal.esm-e5069ce0.js" as="script"><link rel="prefetch" href="/assets/search.esm-2c3fba7d.js" as="script"><link rel="prefetch" href="/assets/zoom.esm-b83b91d0.js" as="script"><link rel="prefetch" href="/assets/VuePlayground-26db9bcf.js" as="script"><link rel="prefetch" href="/assets/photoswipe.esm-6e6cbe40.js" as="script"><link rel="prefetch" href="/assets/SearchResult-59a86d3d.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="skip-link sr-only">跳至主要內容</a><!--]--><div class="theme-container no-sidebar has-toc"><!--[--><header class="navbar" id="navbar"><div class="navbar-start"><button class="toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><a href="/" class="brand"><img class="logo" src="/white-logo.png" alt="白先生"><!----><span class="site-name hide-in-pad">白先生</span></a><!--[--><!----><!--]--></div><div class="navbar-center"><!--[--><!----><!--]--><nav class="nav-links"><div class="nav-item hide-in-mobile"><a href="/" class="nav-link" aria-label="主页"><span class="font-icon icon iconfont icon-home" style=""></span>主页<!----></a></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="索引"><span class="title"><span class="font-icon icon iconfont icon-structure" style=""></span>索引</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/article/" class="nav-link" aria-label="文章列表"><span class="font-icon icon iconfont icon-blog" style=""></span>文章列表<!----></a></li><li class="dropdown-item"><a href="/category/" class="nav-link" aria-label="分类"><span class="font-icon icon iconfont icon-categoryselected" style=""></span>分类<!----></a></li><li class="dropdown-item"><a href="/tag/" class="nav-link" aria-label="标签"><span class="font-icon icon iconfont icon-tag" style=""></span>标签<!----></a></li><li class="dropdown-item"><a href="/star/" class="nav-link" aria-label="代表作"><span class="font-icon icon iconfont icon-hot" style=""></span>代表作<!----></a></li><li class="dropdown-item"><a href="/timeline/" class="nav-link" aria-label="时间线"><span class="font-icon icon iconfont icon-time" style=""></span>时间线<!----></a></li></ul></button></div></div></nav><!--[--><!----><!--]--></div><div class="navbar-end"><!--[--><!----><!--]--><!----><!----><div class="nav-item hide-in-mobile"><button class="outlook-button" tabindex="-1" ariahidden="true"><svg xmlns="http://www.w3.org/2000/svg" class="icon outlook-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="outlook icon"><path d="M224 800c0 9.6 3.2 44.8 6.4 54.4 6.4 48-48 76.8-48 76.8s80 41.6 147.2 0 134.4-134.4 38.4-195.2c-22.4-12.8-41.6-19.2-57.6-19.2C259.2 716.8 227.2 761.6 224 800zM560 675.2l-32 51.2c-51.2 51.2-83.2 32-83.2 32 25.6 67.2 0 112-12.8 128 25.6 6.4 51.2 9.6 80 9.6 54.4 0 102.4-9.6 150.4-32l0 0c3.2 0 3.2-3.2 3.2-3.2 22.4-16 12.8-35.2 6.4-44.8-9.6-12.8-12.8-25.6-12.8-41.6 0-54.4 60.8-99.2 137.6-99.2 6.4 0 12.8 0 22.4 0 12.8 0 38.4 9.6 48-25.6 0-3.2 0-3.2 3.2-6.4 0-3.2 3.2-6.4 3.2-6.4 6.4-16 6.4-16 6.4-19.2 9.6-35.2 16-73.6 16-115.2 0-105.6-41.6-198.4-108.8-268.8C704 396.8 560 675.2 560 675.2zM224 419.2c0-28.8 22.4-51.2 51.2-51.2 28.8 0 51.2 22.4 51.2 51.2 0 28.8-22.4 51.2-51.2 51.2C246.4 470.4 224 448 224 419.2zM320 284.8c0-22.4 19.2-41.6 41.6-41.6 22.4 0 41.6 19.2 41.6 41.6 0 22.4-19.2 41.6-41.6 41.6C339.2 326.4 320 307.2 320 284.8zM457.6 208c0-12.8 12.8-25.6 25.6-25.6 12.8 0 25.6 12.8 25.6 25.6 0 12.8-12.8 25.6-25.6 25.6C470.4 233.6 457.6 220.8 457.6 208zM128 505.6C128 592 153.6 672 201.6 736c28.8-60.8 112-60.8 124.8-60.8-16-51.2 16-99.2 16-99.2l316.8-422.4c-48-19.2-99.2-32-150.4-32C297.6 118.4 128 291.2 128 505.6zM764.8 86.4c-22.4 19.2-390.4 518.4-390.4 518.4-22.4 28.8-12.8 76.8 22.4 99.2l9.6 6.4c35.2 22.4 80 12.8 99.2-25.6 0 0 6.4-12.8 9.6-19.2 54.4-105.6 275.2-524.8 288-553.6 6.4-19.2-3.2-32-19.2-32C777.6 76.8 771.2 80 764.8 86.4z"></path></svg><div class="outlook-dropdown"><!----></div></button></div><!--[--><button class="search-pro-button" role="search" aria-label="搜索"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg><div class="placeholder">搜索</div><div class="key-hints"><kbd class="key">Ctrl</kbd><kbd class="key">K</kbd></div></button><!--]--><!--[--><!----><!--]--><button class="toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span class="button-container"><span class="button-top"></span><span class="button-middle"></span><span class="button-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside class="sidebar" id="sidebar"><!--[--><!----><!--]--><ul class="sidebar-links"></ul><!--[--><!----><!--]--></aside><!--[--><main class="page" id="main-content"><!--[--><!----><nav class="breadcrumb disable"></nav><div class="page-title"><h1><!---->JUC——Java并发编程</h1><div class="page-info"><span class="page-author-info" aria-label="作者🖊" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="page-author-item" href="https://littlebai118.github.io/" target="_blank" rel="noopener noreferrer">Mr.Bai</a></span><span property="author" content="Mr.Bai"></span></span><!----><span class="page-date-info" aria-label="写作日期📅" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2023-05-15T11:20:49.000Z"></span><!----><span class="page-reading-time-info" aria-label="阅读时间⌛" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>大约 33 分钟</span><meta property="timeRequired" content="PT33M"></span><span class="page-category-info" aria-label="分类🌈" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="category icon"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></svg><span class="page-category-item category7 clickable" role="navigation">JUC</span><meta property="articleSection" content="JUC"></span><span class="page-tag-info" aria-label="标签🏷" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="tag icon"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></svg><span class="page-tag-item tag7 clickable" role="navigation">JUC</span><meta property="keywords" content="JUC"></span></div><hr></div><div class="toc-place-holder"><aside id="toc"><!--[--><!----><!--]--><div class="toc-header">此页内容<button class="print-button" title="打印"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button></div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/juc/JUC.html#进程与线程" class="router-link-active router-link-exact-active toc-link level2">进程与线程</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/juc/JUC.html#进程" class="router-link-active router-link-exact-active toc-link level3">进程</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/juc/JUC.html#线程" class="router-link-active router-link-exact-active toc-link level3">线程</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/juc/JUC.html#进程和线程对比" class="router-link-active router-link-exact-active toc-link level3">进程和线程对比</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/juc/JUC.html#并发" class="router-link-active router-link-exact-active toc-link level3">并发</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/juc/JUC.html#并行" class="router-link-active router-link-exact-active toc-link level3">并行</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/juc/JUC.html#同步与异步" class="router-link-active router-link-exact-active toc-link level3">同步与异步</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/juc/JUC.html#线程基础知识" class="router-link-active router-link-exact-active toc-link level2">线程基础知识</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/juc/JUC.html#线程的创建" class="router-link-active router-link-exact-active toc-link level3">线程的创建</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/juc/JUC.html#线程上下文切换-thread-context-switch" class="router-link-active router-link-exact-active toc-link level3">线程上下文切换（Thread Context Switch)</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/juc/JUC.html#start和run方法" class="router-link-active router-link-exact-active toc-link level3">Start和Run方法</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/juc/JUC.html#sleep方法" class="router-link-active router-link-exact-active toc-link level3">Sleep方法</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/juc/JUC.html#yield方法" class="router-link-active router-link-exact-active toc-link level3">Yield方法</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/juc/JUC.html#线程优先级" class="router-link-active router-link-exact-active toc-link level3">线程优先级</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/juc/JUC.html#join方法" class="router-link-active router-link-exact-active toc-link level3">Join方法</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/juc/JUC.html#interrupt方法" class="router-link-active router-link-exact-active toc-link level3">Interrupt方法</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/juc/JUC.html#守护线程" class="router-link-active router-link-exact-active toc-link level3">守护线程</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/juc/JUC.html#线程状态" class="router-link-active router-link-exact-active toc-link level3">线程状态</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/juc/JUC.html#共享模型之管程" class="router-link-active router-link-exact-active toc-link level2">共享模型之管程</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/juc/JUC.html#synchronized" class="router-link-active router-link-exact-active toc-link level3">Synchronized</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/juc/JUC.html#变量的线程安全分析" class="router-link-active router-link-exact-active toc-link level3">变量的线程安全分析</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/juc/JUC.html#线程安全的类" class="router-link-active router-link-exact-active toc-link level3">线程安全的类</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/juc/JUC.html#synchronized底层原理" class="router-link-active router-link-exact-active toc-link level3">Synchronized底层原理</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/juc/JUC.html#wait-notify" class="router-link-active router-link-exact-active toc-link level3">Wait/Notify</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/juc/JUC.html#park-unpark" class="router-link-active router-link-exact-active toc-link level3">Park/Unpark</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/juc/JUC.html#死锁" class="router-link-active router-link-exact-active toc-link level3">死锁</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/juc/JUC.html#活锁" class="router-link-active router-link-exact-active toc-link level3">活锁</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/juc/JUC.html#定位检测死锁" class="router-link-active router-link-exact-active toc-link level3">定位检测死锁</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/juc/JUC.html#reentrantlock" class="router-link-active router-link-exact-active toc-link level3">ReentrantLock</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/juc/JUC.html#共享模型之内存" class="router-link-active router-link-exact-active toc-link level2">共享模型之内存</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/juc/JUC.html#java内存模型" class="router-link-active router-link-exact-active toc-link level3">Java内存模型</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/juc/JUC.html#volatile" class="router-link-active router-link-exact-active toc-link level3">Volatile</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/juc/JUC.html#cas" class="router-link-active router-link-exact-active toc-link level3">CAS</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/juc/JUC.html#线程池" class="router-link-active router-link-exact-active toc-link level2">线程池</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/juc/JUC.html#为什么要使用线程池" class="router-link-active router-link-exact-active toc-link level3">为什么要使用线程池</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/juc/JUC.html#线程池中的线程" class="router-link-active router-link-exact-active toc-link level3">线程池中的线程</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/juc/JUC.html#创建线程池的方式" class="router-link-active router-link-exact-active toc-link level3">创建线程池的方式</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/juc/JUC.html#线程池状态" class="router-link-active router-link-exact-active toc-link level3">线程池状态</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/juc/JUC.html#线程池的饱和策略" class="router-link-active router-link-exact-active toc-link level3">线程池的饱和策略</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/juc/JUC.html#线程池的任务处理流程" class="router-link-active router-link-exact-active toc-link level3">线程池的任务处理流程</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/juc/JUC.html#threadlocal" class="router-link-active router-link-exact-active toc-link level2">ThreadLocal</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/juc/JUC.html#原理" class="router-link-active router-link-exact-active toc-link level3">原理</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/juc/JUC.html#threadlocal的内存泄露风险" class="router-link-active router-link-exact-active toc-link level3">ThreadLocal的内存泄露风险</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/juc/JUC.html#使用场景" class="router-link-active router-link-exact-active toc-link level3">使用场景</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/juc/JUC.html#aqs" class="router-link-active router-link-exact-active toc-link level2">AQS</a></li><!----><!--]--></ul></div><!--[--><!----><!--]--></aside></div><!----><div class="theme-hope-content"><h2 id="进程与线程" tabindex="-1"><a class="header-anchor" href="#进程与线程" aria-hidden="true">#</a> 进程与线程</h2><h3 id="进程" tabindex="-1"><a class="header-anchor" href="#进程" aria-hidden="true">#</a> 进程</h3><p>程序由指令和数据组成，但这些指令要运行，数据要读写，就必须将指令加载至CPU，数据加载至内存。在指令运行过程中还需要用到磁盘、网络等设备。进程就是用来加载指令、管理内存、管理IO的。当一个程序被运行，从磁盘加载这个程序的代码至内存，这时就开启了一个进程。 进程就可以视为程序的一个实例。大部分程序可以同时运行多个实例进程（例如记事本、画图、浏览器等)，也有的程序只能启动一个实例进程（例如网易云音乐、360安全卫士等)。</p><h3 id="线程" tabindex="-1"><a class="header-anchor" href="#线程" aria-hidden="true">#</a> 线程</h3><p>一个进程之内可以分为一到多个线程。 一个线程就是一个指令流，将指令流中的一条条指令以一定的顺序交给CPU执行 Java中，线程作为最小调度单位，进程作为资源分配的最小单位。在windows 中进程是不活动的，只是作为线程的容器。</p><h3 id="进程和线程对比" tabindex="-1"><a class="header-anchor" href="#进程和线程对比" aria-hidden="true">#</a> 进程和线程对比</h3><ul><li><p>进程基本上相互独立的，而线程存在于进程内，是进程的一个子集</p></li><li><p>进程拥有共享的资源，如内存空间等，供其内部的线程共享</p></li><li><p>进程通信比线程复杂</p><ul><li><p>进程间通信较为复杂，同一台计算机的进程通信称为IPC (Inter-process communication)；不同计算机之间的进程通信，需要通过网络，并遵守共同的协议，例如HTTP。</p></li><li><p>线程通信相对简单，因为它们共享进程内的内存，一个例子是多个线程可以访问同一个共享变量</p></li></ul></li><li><p>线程更轻量，线程上下文切换成本一般上要比进程上下文切换低</p></li></ul><h3 id="并发" tabindex="-1"><a class="header-anchor" href="#并发" aria-hidden="true">#</a> 并发</h3><p>单核cpu下，线程实际还是串行执行的。操作系统中有一个组件叫做任务调度器，将cpu的时间片( windows下时间片最小约为115亳秒)分给不同的线程使用，只是由于cpu在线程间（时间片很短）的切换非常快，人类感觉是同时运行的。总结为一句话就是:微观串行，宏双并行，将多线程同时使用CPU的行为叫做并发，Concurrent。</p><h3 id="并行" tabindex="-1"><a class="header-anchor" href="#并行" aria-hidden="true">#</a> 并行</h3><p>多核CPU可以同时调度运行线程，这时是并行，parallel。</p><h3 id="同步与异步" tabindex="-1"><a class="header-anchor" href="#同步与异步" aria-hidden="true">#</a> 同步与异步</h3><p>从方法调用的角度来讲，如果</p><ul><li><p>需要等待结果返回，才能继续运行就是同步</p></li><li><p>不需要等待结果返回，就能继续运行就是异步</p></li></ul><p>注意:同步在多线程中还有另外一层意思，是让多个线程步调一致</p><p>Java中采用多线程可以异步调用方法</p><h2 id="线程基础知识" tabindex="-1"><a class="header-anchor" href="#线程基础知识" aria-hidden="true">#</a> 线程基础知识</h2><h3 id="线程的创建" tabindex="-1"><a class="header-anchor" href="#线程的创建" aria-hidden="true">#</a> 线程的创建</h3><h4 id="方式一-使用thread类" tabindex="-1"><a class="header-anchor" href="#方式一-使用thread类" aria-hidden="true">#</a> 方式一（使用Thread类）</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">//创建线程 构造方法可以指定线程的名字</span>
<span class="token class-name">Thread</span> thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token string">&quot;FirstThread&quot;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">//启动线程</span>
thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="方式二-使用runnable接口" tabindex="-1"><a class="header-anchor" href="#方式二-使用runnable接口" aria-hidden="true">#</a> 方式二（使用Runnable接口）</h4><p>该方法的好处是可以将线程的创建和线程的执行分开</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">//创建线程</span>
<span class="token class-name">Runnable</span> runnable <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;你好&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">//运行线程,构建Thread对象</span>
<span class="token class-name">Thread</span> thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>runnable<span class="token punctuation">)</span><span class="token punctuation">;</span>
thread<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;RunnableThread&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Runnable接口还可以使用lambda表达式创建对象。</p><p>方式一和方式二两者在本质上近乎相同，如果使用Runnable对象构建方法，Thread对象会在run方法中调用Runnable的run方法。使用Runnable接口可以巧妙的避开Thread的继承体系，更加灵活。</p><h4 id="方式三-使用futuretask" tabindex="-1"><a class="header-anchor" href="#方式三-使用futuretask" aria-hidden="true">#</a> 方式三（使用FutureTask）</h4><p>该方式可以获得执行的返回值，FutureTask需要配合Callable使用</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">//创建FutureTask</span>
<span class="token class-name">FutureTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> futureTask <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FutureTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Callable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;My return is 100&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">100</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//创建Thread</span>
<span class="token class-name">Thread</span> taskThread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>futureTask<span class="token punctuation">)</span><span class="token punctuation">;</span>
taskThread<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;futureTask&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//启动线程</span>
taskThread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//获得线程的返回值，在执行get方法前，如果线程没有结束，程序会在此阻塞</span>
logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;FutureTask return value is &quot;</span> <span class="token operator">+</span> futureTask<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="线程上下文切换-thread-context-switch" tabindex="-1"><a class="header-anchor" href="#线程上下文切换-thread-context-switch" aria-hidden="true">#</a> 线程上下文切换（Thread Context Switch)</h3><p>因为以下一些原因导致cpu不再执行当前的线程，转而执行另一个线程的代码就是线程上下文的切换。</p><ul><li><p>线程的cpu时间片用完</p></li><li><p>垃圾回收</p></li><li><p>有更高优先级的线程需要运行</p></li><li><p>线程自己调用了sleep、yield、wait、join、park、synchronized、lock等方法</p></li></ul><p>当Context Switch发生时，需要由操作系统保存当前线程的状态（状态包括程序计数器、虚拟机栈中每个栈帧的信息等），并恢复另一个线程的状态，JVM中对应的概念就是程序计数器(Program Counter Register)，它的作用是记住下一条JVM指令的执行地址。Context Switch频繁发生会影响性能，所以线程并不是越多越好。</p><h3 id="start和run方法" tabindex="-1"><a class="header-anchor" href="#start和run方法" aria-hidden="true">#</a> Start和Run方法</h3><p>直接调用 run 是在主线程中直接执行了run方法，没有启动新的线程</p><p>使用 start 是启动新的线程，通过新的线程执行run 中的代码</p><h3 id="sleep方法" tabindex="-1"><a class="header-anchor" href="#sleep方法" aria-hidden="true">#</a> Sleep方法</h3><ol><li><p>调用 sleep 会让当前线程从 Running 进入 Timed Waiting 状态（阻塞）</p></li><li><p>其它线程可以使用 interrupt 方法打断正在睡眠的线程，这时 sleep 方法会抛出 InterruptedException</p></li><li><p>睡眠结束后的线程未必会立刻得到执行</p></li><li><p>建议用 TimeUnit 的 sleep 代替 Thread 的 sleep 来获得更好的可读性</p></li></ol><h3 id="yield方法" tabindex="-1"><a class="header-anchor" href="#yield方法" aria-hidden="true">#</a> Yield方法</h3><p>1.调用yield 会让当前线程从Running进入Runnable 就绪状态，然后调度执行其它线程</p><p>2.具体的实现依赖于操作系统的任务调度器</p><p>Yield方法会让线程进入就绪状态（Runnable），就绪状态依旧可能会被CPU分配时间片。Sleep方法会使线程进入阻塞状态，CPU不会讲时间片分配给阻塞状态的线程。</p><h3 id="线程优先级" tabindex="-1"><a class="header-anchor" href="#线程优先级" aria-hidden="true">#</a> 线程优先级</h3><p>优先级是Thread类的setPriority方法来进行设置。线程优先级会提示(hint)调度器优先调度该线程，但它仅仅是一个提示，<strong>调度器可以忽略它</strong>。如果cpu比较忙，那么优先级高的线程会获得更多的时间片，但cpu闲时，优先级几乎没作用。</p><h3 id="join方法" tabindex="-1"><a class="header-anchor" href="#join方法" aria-hidden="true">#</a> Join方法</h3><p>Jion方法可以等待某个线程结束。调用Join后，调用Join的线程会阻塞，直到被调用Join的线程结束，调用Join的线程才会恢复运行</p><h4 id="同步" tabindex="-1"><a class="header-anchor" href="#同步" aria-hidden="true">#</a> 同步</h4><p>以调用方角度来讲，如果</p><ul><li><p>需要等待结果返回，才能继续运行就是同步</p></li><li><p>不需要等待结果返回，就能继续运行就是异步</p></li></ul><figure><img src="/assets/2022-07-05-18-12-08-image-9c20708a.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>join方法还有一个有参数的重载方法，该方法可以设置等待的最长毫秒数。</p><h3 id="interrupt方法" tabindex="-1"><a class="header-anchor" href="#interrupt方法" aria-hidden="true">#</a> Interrupt方法</h3><blockquote><p>可以使用一下两种方法测试线程的打断标记</p><p><strong>public boolean isInterrupted()</strong></p><p>测试这个线程是否被中断。 线程的<em>中断状态</em>不受此方法的影响。</p><p>忽略线程中断，因为线程在中断时不存在将被该方法返回false所反映。</p><p>结果</p><p><code>true</code>如果这个线程已被中断; <code>false</code>否则。</p><p><strong>public static boolean interrupted()</strong></p><p>测试当前线程是否中断。 该方法可以清除线程的<em>中断状态</em> 。 换句话说，如果这个方法被连续调用两次，那么第二个调用将返回false（除非当前线程再次中断，在第一个调用已经清除其中断状态之后，在第二个调用之前已经检查过）。</p><p>忽略线程中断，因为线程在中断时不存在将被该方法返回false所反映。</p><p>结果</p><p><code>true</code>如果当前线程已被中断; <code>false</code>否则。</p></blockquote><h4 id="打断被sleep、wait、join阻塞的线程" tabindex="-1"><a class="header-anchor" href="#打断被sleep、wait、join阻塞的线程" aria-hidden="true">#</a> 打断被sleep、wait、join阻塞的线程</h4><p>打断这些线程会使得被打断的线程抛出InterruptedException异常，并不会导致打断标记为真</p><h4 id="打断正常运行的线程" tabindex="-1"><a class="header-anchor" href="#打断正常运行的线程" aria-hidden="true">#</a> 打断正常运行的线程</h4><p>会使得打断标记为真</p><h4 id="打断park线程" tabindex="-1"><a class="header-anchor" href="#打断park线程" aria-hidden="true">#</a> 打断park线程</h4><blockquote><p>LockSupport.park()</p><hr><p><strong>public static void park()</strong></p><p>禁止当前线程进行线程调度，除非许可证可用。</p><p>如果许可证可用，则它被消耗，并且该呼叫立即返回; 否则当前线程对于线程调度目的将被禁用，并且处于休眠状态，直至发生三件事情之一：</p><ul><li>一些其他线程调用当前线程作为目标的<a href="/java/util/concurrent/locks/LockSupport.html#unpark-java.lang.Thread-" class=""><code>unpark</code></a> ; 要么</li><li>其他一些线程当前线程为<a href="/java/lang/Thread.html#interrupt--" class="">interrupts</a> ; 要么</li><li>电话虚假（也就是说，没有理由）返回。</li></ul><p>这种方法<em>不</em>报告是哪个线程导致该方法返回。 来电者应重新检查导致线程首先停放的条件。 呼叫者还可以确定线程在返回时的中断状态。</p><hr><p>注意：只有在中断标记为假的时候，park方法才能阻断线程的运行</p></blockquote><p>使用interrupt方法打断park方法阻断的线程时，会使得线程恢复运行。</p><h4 id="jdk不推荐使用的过时方法" tabindex="-1"><a class="header-anchor" href="#jdk不推荐使用的过时方法" aria-hidden="true">#</a> JDK不推荐使用的过时方法</h4><table><thead><tr><th>方法名</th><th>功能说明</th></tr></thead><tbody><tr><td>stop()</td><td>停止线程运行</td></tr><tr><td>suspend()</td><td>挂起（暂停）线程运行</td></tr><tr><td>resume()</td><td>恢复线程运行</td></tr></tbody></table><h3 id="守护线程" tabindex="-1"><a class="header-anchor" href="#守护线程" aria-hidden="true">#</a> 守护线程</h3><p>默认情况下，Java 进程需要等待所有线程都运行结束，才会结束。有一种特殊的线程叫做守护线程，只要其它非守护线程运行结束了，即使守护线程的代码没有执行完，也会强制结束。</p><p>在线程start()前调用其的setDaemon(true)方法即可将该线程设置成为守护线程。</p><h3 id="线程状态" tabindex="-1"><a class="header-anchor" href="#线程状态" aria-hidden="true">#</a> 线程状态</h3><h4 id="操作系统层面" tabindex="-1"><a class="header-anchor" href="#操作系统层面" aria-hidden="true">#</a> 操作系统层面</h4><figure><img src="/assets/2022-07-13-14-38-35-未命名文件(67)-81066fc6.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>操作系统层面的阻塞是指调用了阻塞的API，如BIO的文件读取API，在Java中”可运行“、”运行“、”阻塞“同属”可运行状态“，Java中的阻塞是指当先线程试图获得一个由其他线程占有的锁时，它会被阻塞。</p><figure><img src="/assets/2022-07-13-14-46-34-未命名文件(68)-f65c8e26.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h2 id="共享模型之管程" tabindex="-1"><a class="header-anchor" href="#共享模型之管程" aria-hidden="true">#</a> 共享模型之管程</h2><h3 id="synchronized" tabindex="-1"><a class="header-anchor" href="#synchronized" aria-hidden="true">#</a> Synchronized</h3><h4 id="synchronized代码块" tabindex="-1"><a class="header-anchor" href="#synchronized代码块" aria-hidden="true">#</a> Synchronized代码块</h4><p>synchronized，来解决临界区的竞态条件发生，即俗称的【对象锁】，它采用互斥的方式让同一时刻至多只有一个线程能持有【对象锁】，其它线程再想获取这个【对象锁】时就会阻塞住。这样就能保证拥有锁的线程可以安全的执行临界区内的代码，不用担心线程上下文切换。</p><blockquote><p>注意</p><p>虽然 java 中互斥和同步都可以采用 synchronized 关键字来完成，但它们还是有区别的：</p><p>互斥是保证临界区的竞态条件发生，同一时刻只能有一个线程执行临界区代码</p><p>同步是由于线程执行的先后、顺序不同、需要一个线程等待其它线程运行到某个点</p></blockquote><p>代码示例：</p><p>不加Synchronize的多个线程对变量的读写</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>parctice</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>logging<span class="token punctuation">.</span>log4j<span class="token punctuation">.</span></span><span class="token class-name">LogManager</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>logging<span class="token punctuation">.</span>log4j<span class="token punctuation">.</span></span><span class="token class-name">Logger</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Practice3</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LogManager</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">Practice3</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Object</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> value <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Thread</span> threadAdd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                value<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span> threadSub <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                value<span class="token operator">--</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        threadAdd<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        threadSub<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        threadAdd<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        threadSub<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;计算后的值为：{}&quot;</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>结果不能确定为多少：</p><figure><img src="/assets/2022-07-13-16-11-40-image-d57c9609.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>加了Synchronized的代码：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>parctice</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>logging<span class="token punctuation">.</span>log4j<span class="token punctuation">.</span></span><span class="token class-name">LogManager</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>logging<span class="token punctuation">.</span>log4j<span class="token punctuation">.</span></span><span class="token class-name">Logger</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Practice3</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LogManager</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">Practice3</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Object</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> value <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Thread</span> threadAdd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>lock<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    value<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span> threadSub <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>lock<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    value<span class="token operator">--</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        threadAdd<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        threadSub<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        threadAdd<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        threadSub<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;计算后的值为：{}&quot;</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>其运行结果总是0；</p><p>Synchronized还可以对当先对象加锁，实例如下</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Practice4</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LogManager</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">Practice4</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Room</span> room <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Room</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span> t1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">500</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                room<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span> t2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">500</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                room<span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t1<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t2<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>room<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">Room</span><span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            count<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sub</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            count<span class="token operator">--</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> count<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="/assets/2022-07-18-15-09-37-image-e2561ee8.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h4 id="synchronized方法" tabindex="-1"><a class="header-anchor" href="#synchronized方法" aria-hidden="true">#</a> Synchronized方法</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">Test</span><span class="token punctuation">{</span>
    <span class="token comment">//普通方法上的synchronized</span>
    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">//↑等价于↓</span>
<span class="token keyword">class</span> <span class="token class-name">Test</span><span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">Test</span><span class="token punctuation">{</span>
    <span class="token comment">//静态方法上的synchronized</span>
    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">//↑等价于↓</span>
<span class="token keyword">class</span> <span class="token class-name">Test</span><span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span><span class="token punctuation">(</span><span class="token class-name">Test</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="变量的线程安全分析" tabindex="-1"><a class="header-anchor" href="#变量的线程安全分析" aria-hidden="true">#</a> 变量的线程安全分析</h3><h4 id="成员变量和静态变量的线程安全问题" tabindex="-1"><a class="header-anchor" href="#成员变量和静态变量的线程安全问题" aria-hidden="true">#</a> 成员变量和静态变量的线程安全问题</h4><p>如果它们没有被共享，则是线程安全的</p><p>如果它门被共享了，共享过程中如果只有读操作，则线程安全，如果同时具有读写操作，则需要考虑线程安全问题</p><h4 id="局部变量的线程安全问题" tabindex="-1"><a class="header-anchor" href="#局部变量的线程安全问题" aria-hidden="true">#</a> 局部变量的线程安全问题</h4><p>局部变量自身是线程安全的</p><p>局部变量如果是引用类型，其引用的对象未必是线程安全的</p><ul><li><p>如果该对象没有逃离当前方法的作用范围，则它是线程安全的</p></li><li><p>如果该对象逃离了当前方法的作用范围，则需要考虑线程安全问题</p></li></ul><h3 id="线程安全的类" tabindex="-1"><a class="header-anchor" href="#线程安全的类" aria-hidden="true">#</a> 线程安全的类</h3><p>String</p><p>基本类型的包装类</p><p>StringBuffffer</p><p>Random</p><p>Vector</p><p>Hashtable</p><p>java.util.concurrent 包下的类</p><p>这些类的方法是线程安全的，但是方法的组合不一定是原子的</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">Hashtable</span> table <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Hashtable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span> table<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;key&quot;</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 table<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;key&quot;</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这段操作就是不安全的</p><h3 id="synchronized底层原理" tabindex="-1"><a class="header-anchor" href="#synchronized底层原理" aria-hidden="true">#</a> Synchronized底层原理</h3><h4 id="java对象头" tabindex="-1"><a class="header-anchor" href="#java对象头" aria-hidden="true">#</a> Java对象头</h4><p>对象在内存中由两部分构成对象头+数据（成员变量）</p><p>普通对象</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span> 
<span class="token operator">|</span>                <span class="token class-name">Object</span> <span class="token class-name">Header</span> <span class="token punctuation">(</span><span class="token number">64</span> bits<span class="token punctuation">)</span>                       <span class="token operator">|</span>
<span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">|</span>
<span class="token operator">|</span>           <span class="token class-name">Mark</span> <span class="token class-name">Word</span> <span class="token punctuation">(</span><span class="token number">32</span> bits<span class="token punctuation">)</span>      <span class="token operator">|</span>   <span class="token class-name">Klass</span> <span class="token class-name">Word</span> <span class="token punctuation">(</span><span class="token number">32</span> bits<span class="token punctuation">)</span>  <span class="token operator">|</span>
<span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">|</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>数组对象</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">|</span>
<span class="token operator">|</span>                                <span class="token class-name">Object</span> <span class="token class-name">Header</span> <span class="token punctuation">(</span><span class="token number">96</span> bits<span class="token punctuation">)</span>                          <span class="token operator">|</span>
<span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span>
<span class="token operator">|</span>       <span class="token class-name">Mark</span> <span class="token class-name">Word</span><span class="token punctuation">(</span><span class="token number">32</span>bits<span class="token punctuation">)</span>        <span class="token operator">|</span>   <span class="token class-name">Klass</span> <span class="token class-name">Word</span><span class="token punctuation">(</span><span class="token number">32</span>bits<span class="token punctuation">)</span>  <span class="token operator">|</span>  array <span class="token function">length</span><span class="token punctuation">(</span><span class="token number">32</span>bits<span class="token punctuation">)</span>  <span class="token operator">|</span>
<span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Klass Word指向对象所从属的类对象，从而确定当前对象的类型</p><p>MarkWord结构</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span>
<span class="token operator">|</span>                   <span class="token class-name">Mark</span> <span class="token class-name">Word</span> <span class="token punctuation">(</span><span class="token number">32</span> bits<span class="token punctuation">)</span>            <span class="token operator">|</span>标记位<span class="token operator">|</span>        <span class="token class-name">State</span>       <span class="token operator">|</span>
<span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span>
<span class="token operator">|</span>    hashcode<span class="token operator">:</span><span class="token number">25</span>   <span class="token operator">|</span>    age<span class="token operator">:</span><span class="token number">4</span>  <span class="token operator">|</span>   biased_lock<span class="token operator">:</span><span class="token number">0</span>   <span class="token operator">|</span> <span class="token number">01</span>  <span class="token operator">|</span>      <span class="token class-name">Normal</span>        <span class="token operator">|</span>
<span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span>
<span class="token operator">|</span>    thread<span class="token operator">:</span><span class="token number">23</span>  <span class="token operator">|</span> epoch<span class="token operator">:</span><span class="token number">2</span> <span class="token operator">|</span>  age<span class="token operator">:</span><span class="token number">4</span> <span class="token operator">|</span> biased_lock<span class="token operator">:</span><span class="token number">1</span> <span class="token operator">|</span> <span class="token number">01</span>  <span class="token operator">|</span>      <span class="token class-name">Biased</span>        <span class="token operator">|</span>
<span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span>
<span class="token operator">|</span>      ptr_to_lock_record<span class="token operator">:</span><span class="token number">30</span>                       <span class="token operator">|</span> <span class="token number">00</span>  <span class="token operator">|</span> <span class="token class-name">Lightweight</span> <span class="token class-name">Locked</span> <span class="token operator">|</span>
<span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span>
<span class="token operator">|</span>      ptr_to_heavyweight_monitor<span class="token operator">:</span><span class="token number">30</span>               <span class="token operator">|</span> <span class="token number">10</span>  <span class="token operator">|</span> <span class="token class-name">Heavyweight</span> <span class="token class-name">Locked</span> <span class="token operator">|</span>
<span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span>
<span class="token operator">|</span>                                                  <span class="token operator">|</span> <span class="token number">11</span>  <span class="token operator">|</span>    <span class="token class-name">Marked</span> <span class="token keyword">for</span> <span class="token constant">GC</span>   <span class="token operator">|</span>
<span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="monitor" tabindex="-1"><a class="header-anchor" href="#monitor" aria-hidden="true">#</a> Monitor</h4><p>Monitor可以被翻译成监视器或者管程。</p><blockquote><p>在 Java 虚拟机(HotSpot)中，Monitor 是基于 C++实现的，由<a href="https://github.com/openjdk-mirror/jdk7u-hotspot/blob/50bdefc3afe944ca74c3093e7448d6b889cd20d1/src/share/vm/runtime/objectMonitor.cpp" target="_blank" rel="noopener noreferrer">ObjectMonitoropen in new window<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>实现的。每个对象中都内置了一个 <code>ObjectMonitor</code>对象。</p><p>另外，<code>wait/notify</code>等方法也依赖于<code>monitor</code>对象，这就是为什么只有在同步的块或者方法中才能调用<code>wait/notify</code>等方法，否则会抛出<code>java.lang.IllegalMonitorStateException</code>的异常的原因。</p></blockquote><p>每个Java对象都可以关联一个Monitor对象，如果使用synchronized给对象上锁之后，该对象的对象头中的Mark Word中就被设置指向Monitor的对象的指针。</p><p>Monitor中有很多成员变量</p><figure><img src="/assets/2022-07-26-14-10-12-image-82d050b4.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>1.刚开始Monitor 中 Owner为null</p><p>2.当Thread-2执行synchronized(obj)就会将Monitor 的所有者Owner置为Thread-2，Monitor中只能有一个Owner</p><p>3.在Thread-2上锁的过程中，如果Thread-3，Thread-4，Thread-5也来执行synchronized(obj)，就会进入EntryList这些线程的状态为BLOCKED</p><p>4.Thread-2执行完同步代码块的内容，然后唤醒EntryList 中等待的线程来竞争锁，竞争的时是非公平的</p><p>5.图中WaitSet 中存储的是之前获得过锁，但条件不满足进入WAITING 状态的线程</p><h4 id="轻量级锁" tabindex="-1"><a class="header-anchor" href="#轻量级锁" aria-hidden="true">#</a> 轻量级锁</h4><p>轻量级锁的使用场景:如果一个对象虽然有多线程访问，但多线程访问的时间是错开的（也就是没有竞争)，那么可以使用轻量级锁来优化。轻量级锁对使用者是透明的，即语法仍然是synchronized</p><p>假设有两个方法同步块，利用同一个对象加锁。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token keyword">final</span> object obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">method1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">synchronized</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//同步块A</span>
        <span class="token function">method2</span><span class="token punctuation">(</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">method2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">synchronized</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//同步块B</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="轻量级锁的加锁流程" tabindex="-1"><a class="header-anchor" href="#轻量级锁的加锁流程" aria-hidden="true">#</a> 轻量级锁的加锁流程</h5><p>每个线程的栈中都会包含一个锁记录的结构。当一个对象需要被加锁时，首先会让所记录 Lock Record对象中的Object reference指向被锁定的对象。而后通过cas将被锁定对象的Mark Word存入Lock Record对象。</p><figure><img src="/assets/2022-07-27-09-49-07-image-6a4d4f73.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>如果cas失败，会是以下两种情况导致的：</p><ul><li><p>已经有其他线程持有了该对象的轻量级锁（即标志位为00）</p></li><li><p>如果是本线程自己执行了synchronized锁重入，则会再在当前线程的栈中添加一条Lock Record作为重入计数</p><ul><li><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">//代码示例</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> object obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">method1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">synchronized</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//同步块A</span>
        <span class="token function">method2</span><span class="token punctuation">(</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">method2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">synchronized</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//同步块B</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>在进行锁重入时，被加锁对象不会再与新的Lock Record对象交换Mark Word，被加锁对象的Mark Word中的Lock Record指针依旧指向第一个Lock Record对象，但是新的Lock Record对象中的Object Reference依旧会指向被加锁对象。</p><figure><img src="/assets/2022-07-27-10-11-50-image-9d6faa81.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure></li><li><p>当要退出重入锁时，发现如果有取值为NULL的锁记录，即为重入锁，直接清楚掉即可</p></li></ul></li></ul><p>退出轻量级锁时，如果发现锁记录不为NULL，即当前的锁不是重入锁，这时使用cas将Mark Word的值恢复给对象头，即可退出。</p><h4 id="锁膨胀-重量级锁" tabindex="-1"><a class="header-anchor" href="#锁膨胀-重量级锁" aria-hidden="true">#</a> 锁膨胀（重量级锁）</h4><p>如果在尝试加轻量级锁的过程中，cas无法成功，有一种情况是，有其他线程已经为此对象加入上了轻量级锁（发生了竞争），这时需要进行锁膨胀，将轻量级锁变为重量级锁。</p><p>1.首先Thread-0持有了Object的轻量级锁</p><figure><img src="/assets/2022-07-27-10-42-34-image-65493f0c.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>2.此时如果Thread-1也想对Object进行加锁，首先会尝试对Object加轻量锁。但是由于Thread-0已经持有了Object的轻量锁，所以会加锁失败。此时进入锁膨胀阶段。</p><ul><li><p>首先为Object对象申请Monitor对象，让Object的Mark Word指向Monitor对象的地址，Monitor对象中的Owner 指向Thread-0。</p></li><li><p>然后Thread-1自己进入Monitor对象的Entry List。线程状态变为BLOCKED。</p></li></ul><figure><img src="/assets/2022-07-27-10-56-25-image-c973cb62.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>3.当Thread-0同步代码块退出时，Thread-0会释放轻量级锁，这是会尝试使用cas将Mark Word的值恢复给Object，但由于Object的Mark Word已经指向Monitor，cas会失败，这是 则进入重量级锁的解锁流程。即按照Monitor地址，找到Monitor对象，将Owner设置为NULL，唤醒Entry List中BLOCKED的线程。</p><h4 id="自旋优化" tabindex="-1"><a class="header-anchor" href="#自旋优化" aria-hidden="true">#</a> 自旋优化</h4><p>重量级锁竞争时，为了避免线程进入阻塞状态，可以使用自旋优化。当前线程如果想获得某个对象的重量级锁，且这个重量级锁当前被其他线程持有，就可以进行自旋。如果自旋结束后，该重量级锁已经被释放，那么当前线程就可以直接持有该锁，从而避免进入了阻塞状态，从而避免了线程上下文的切换。</p><p>自旋优化只有在多核CPU的情况下才有意义。</p><p>在Java 6之后自旋锁是自适应的，比如对象刚刚的一次自旋操作成功过，那么认为这次自旋成功的可能性会高，就多自旋几次;反之，就少自旋甚至不自旋，总之，比较智能。 自旋会占用CPU时间，单核CPU自旋就是浪费，多核CPU自旋才能发挥优势。</p><p>Java 7之后不能控制是否开启自旋功能</p><h4 id="偏向锁" tabindex="-1"><a class="header-anchor" href="#偏向锁" aria-hidden="true">#</a> 偏向锁</h4><p>轻量级锁在没有竞争时(就自己这个线程)，每次重入仍然需要执行CAS操作。Java 6 中引入了偏向锁来做进一步优化:只有第一次使用CAS将线程ID设置到对象的 Mark Word头，之后发现这个线程ID是自己的就表示没有竞争，不用重新CAS。以后只要不发生竞争，这个对象就归该线程所有。</p><ul><li><p>如果开启了偏向锁（默认开启)，那么对象创建后，markword值为0x05即最后3位为101这时它的thread、epoch、age都为0</p></li><li><p>偏向锁是默认是延迟的，不会在程序启动时立即生效;如果想避免延迟，可以加VM参数-XX:BiasedLockingStartupDelay=0来禁用延迟</p></li></ul><ul><li>如果没有开启偏向锁，那么对象创建后，markword值为0x01，即最后3位为001，这时它的hashcode、age都为0，第一次用到hashcode时才会赋值</li></ul><p>使用<code>-XX:-UseBiasedLocking</code>可以禁用偏向锁（<code>-XX:+UseBiasedLocking</code>为启用偏向锁）</p><p>锁的升级：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>                            如果有其他
       如果偏向锁可用         线程使用锁            发生竞争
无锁<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-&gt;</span>偏向锁<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">&gt;</span>轻量级锁<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-&gt;</span>重量级锁
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="偏向锁的撤销" tabindex="-1"><a class="header-anchor" href="#偏向锁的撤销" aria-hidden="true">#</a> 偏向锁的撤销</h5><p>下列情况会导致偏向锁的不可用。即使设定了<code>-XX:+UseBiasedLocking</code>参数，对象依旧不能使用偏向锁。</p><h6 id="调用对象的hashcode" tabindex="-1"><a class="header-anchor" href="#调用对象的hashcode" aria-hidden="true">#</a> 调用对象的HashCode</h6><p>偏向锁的对象MarkWord中存储的是线程id，如果调用hashCode会导致偏向锁被撤销。</p><ul><li><p>轻量级锁会在锁记录中记录hashCode</p></li><li><p>重量级锁会在Monitor中记录hashCode</p></li><li><p>偏向锁无法存储hashCode</p></li></ul><p>在调用hashCode后使用偏向锁，记得去掉-xX:-UseBiasedLocking</p><h6 id="其他线程使用对象" tabindex="-1"><a class="header-anchor" href="#其他线程使用对象" aria-hidden="true">#</a> 其他线程使用对象</h6><p>当其他线程使用了偏向锁对象，会将偏向锁升级为轻量级锁。</p><h6 id="调用wait-notify" tabindex="-1"><a class="header-anchor" href="#调用wait-notify" aria-hidden="true">#</a> 调用wait/notify</h6><p>wait和notify只用重量级锁（monitor）才能提供，所以调用会导致偏向锁的撤销。</p><h5 id="批量重偏向" tabindex="-1"><a class="header-anchor" href="#批量重偏向" aria-hidden="true">#</a> 批量重偏向</h5><p>如果对象虽然被多个线程访问，但没有竞争，这时偏向了线程T1的对象仍有机会重新偏向T2，重偏向会重置对象的Thread ID</p><p>当一个类所产生的对象撤销偏向锁次数超过一个阈值（默认是20次）后且没有竞争状态时，jvm会在给这些对象加锁时重新加上偏向锁，偏向至加锁线程，而不会升级为轻量级锁。</p><h5 id="批量撤销" tabindex="-1"><a class="header-anchor" href="#批量撤销" aria-hidden="true">#</a> 批量撤销</h5><p>当撤销偏向锁阈值超过40次后，jvm会这样觉得，自己确实偏向错了，根本就不该偏向。于是整个类的所有对象都会变为不可偏向的，新建的对象也是不可偏向的</p><h5 id="锁消除" tabindex="-1"><a class="header-anchor" href="#锁消除" aria-hidden="true">#</a> 锁消除</h5><p>对于不可能发生共享和竞争的同步代码段，JVM中的JIT会将其优化掉，即去除锁</p><p><code>-XX:-EliminateLocks</code>关闭锁消除</p><h3 id="wait-notify" tabindex="-1"><a class="header-anchor" href="#wait-notify" aria-hidden="true">#</a> Wait/Notify</h3><h4 id="wait-notify工作原理" tabindex="-1"><a class="header-anchor" href="#wait-notify工作原理" aria-hidden="true">#</a> Wait/Notify工作原理</h4><figure><img src="/assets/2022-07-27-19-10-11-image-fa5ea03d.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ul><li><p>Owner发现当前的条件不满足当前的工作，可以调用wait()方法，即可令当前线程进入WaitSet，状态变为WAITING。</p></li><li><p>进入WaitSet中WAITING的线程，会在Owner调用notify()或者notifyAll()时被唤醒，被唤醒后不意味着会立刻获得锁，而是会进入EntryList进行竞争。</p></li><li><p>在EntryList中的线程会在Owner线程释放锁时被唤醒，通过竞争获得锁。</p></li></ul><h4 id="api介绍" tabindex="-1"><a class="header-anchor" href="#api介绍" aria-hidden="true">#</a> API介绍</h4><p>wait()：让进入监视器（Monitor）的线程进入到WaitSet等待</p><p>notify()：在WaitSet中等待的线程中挑选一个唤醒</p><p>notifyAll()：将在WaitSet中等待的全部线程都唤醒</p><p>这些都是线程之间协作的手段，都属于Object对象的方法，必须获得此对象的锁，才能调用这几个方法</p><h4 id="wait和sleep" tabindex="-1"><a class="header-anchor" href="#wait和sleep" aria-hidden="true">#</a> Wait和Sleep</h4><p>1.sleep是Thread的方法，wait是Object的方法</p><p>2.sleep不需要强制和synchronized配合使用，但是wait需要和synchronized一起使用</p><p>3.sleep不会释放锁，而wait在等待的时候会释放锁</p><h3 id="park-unpark" tabindex="-1"><a class="header-anchor" href="#park-unpark" aria-hidden="true">#</a> Park/Unpark</h3><p>它们都是LockSupport类中的方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">//暂停当前线程</span>
<span class="token class-name">LockSupport</span><span class="token punctuation">.</span><span class="token function">park</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">//恢复某个线程的运行</span>
<span class="token class-name">LockSupport</span><span class="token punctuation">.</span><span class="token function">unpark</span><span class="token punctuation">(</span>暂停线程对象<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>与 Object 的 wait &amp; notify 相比</strong></p><ul><li><p>wait，notify 和 notifyAll 必须配合 Object Monitor 一起使用，而 park，unpark 不必</p></li><li><p>park &amp; unpark 是以线程为单位来【阻塞】和【唤醒】线程，而 notify 只能随机唤醒一个等待线程，notifyAll是唤醒所有等待线程，就不那么【精确】</p></li><li><p>park &amp; unpark 可以先 unpark，而 wait &amp; notify 不能先 notify</p></li></ul><h3 id="死锁" tabindex="-1"><a class="header-anchor" href="#死锁" aria-hidden="true">#</a> 死锁</h3><p>1、互相持有 就是A进程持有B进程需要继续工作的资源，反过来，B进程同时也持有A进程需要继续工作的资源。 2、循环等待 这个好理解，就是两个进程间互相需要对方的资源，而且不断等待着对方资源。 3、不可剥夺 和优先级一样，不能够一个进程强行从另外一进程把需要的资源强制夺取过来 4、资源互斥 这个意思是说资源必须是独的，一个进程拥有，另外一个进程就不能拥有。</p><h3 id="活锁" tabindex="-1"><a class="header-anchor" href="#活锁" aria-hidden="true">#</a> 活锁</h3><p><em>活锁</em>指的是任务或者执行者没有被阻塞，由于某些条件没有满足，导致一直重复尝试—失败—尝试—失败的过程。处于<em>活锁</em>的实体是在不断的改变状态，<em>活锁</em>有可能自行解开。</p><h3 id="定位检测死锁" tabindex="-1"><a class="header-anchor" href="#定位检测死锁" aria-hidden="true">#</a> 定位检测死锁</h3><p>可以使用JConsole或者JStack来检测</p><h3 id="reentrantlock" tabindex="-1"><a class="header-anchor" href="#reentrantlock" aria-hidden="true">#</a> ReentrantLock</h3><p>基本语法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token class-name">ReentrantLock</span> reentrantLock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//加锁</span>
        reentrantLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span><span class="token punctuation">{</span>
            <span class="token comment">//临界区代码</span>
        <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment">//解锁</span>
            reentrantLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="可重入" tabindex="-1"><a class="header-anchor" href="#可重入" aria-hidden="true">#</a> 可重入</h4><p>可重入是指如果一个线程首次获得了这把锁，那么它没有释放锁的期间，它有权利再次获得这把锁。</p><p>synchronized和reentrantLock都是可重入锁</p><h4 id="可打断" tabindex="-1"><a class="header-anchor" href="#可打断" aria-hidden="true">#</a> 可打断</h4><p>在等待锁的过程中，可以被其他线程给打断。可打断的获得锁的API与普通获得锁的API不同。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Practice6</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LogManager</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">Practice6</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">ReentrantLock</span> reentrantLock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> isRunning <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//主线程先获得锁</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;主线程获得锁&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        reentrantLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//另一个线程在去可打断的获得锁</span>
        <span class="token class-name">Thread</span> thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;启动运行&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            isRunning <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">//可打断的获得锁</span>
                logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;尝试获得锁&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                reentrantLock<span class="token punctuation">.</span><span class="token function">lockInterruptibly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//可打断的获得一个锁</span>
                logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;成功获得锁！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;在等待锁的过程中被打断&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    reentrantLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalMonitorStateException</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
                    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;当前线程未获得锁&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//启动另一个线程</span>
        thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>isRunning<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//主线程去打断尝试获得锁的线程</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;尝试打断{}&quot;</span><span class="token punctuation">,</span> thread<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        thread<span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">//运行结果如下</span>
<span class="token number">10</span><span class="token operator">:</span><span class="token number">18</span><span class="token operator">:</span><span class="token number">21.896</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token class-name">Practice6</span><span class="token operator">:</span><span class="token number">14</span> <span class="token operator">-</span> 主线程获得锁
<span class="token number">10</span><span class="token operator">:</span><span class="token number">18</span><span class="token operator">:</span><span class="token number">21.899</span> <span class="token punctuation">[</span><span class="token class-name">Thread</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token class-name">Practice6</span><span class="token operator">:</span><span class="token number">18</span> <span class="token operator">-</span> 启动运行
<span class="token number">10</span><span class="token operator">:</span><span class="token number">18</span><span class="token operator">:</span><span class="token number">21.899</span> <span class="token punctuation">[</span><span class="token class-name">Thread</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token class-name">Practice6</span><span class="token operator">:</span><span class="token number">22</span> <span class="token operator">-</span> 尝试获得锁
<span class="token number">10</span><span class="token operator">:</span><span class="token number">18</span><span class="token operator">:</span><span class="token number">21.900</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token class-name">Practice6</span><span class="token operator">:</span><span class="token number">41</span> <span class="token operator">-</span> 尝试打断<span class="token class-name">Thread</span><span class="token operator">-</span><span class="token number">1</span>
<span class="token number">10</span><span class="token operator">:</span><span class="token number">18</span><span class="token operator">:</span><span class="token number">21.901</span> <span class="token punctuation">[</span><span class="token class-name">Thread</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token class-name">Practice6</span><span class="token operator">:</span><span class="token number">31</span> <span class="token operator">-</span> 当前线程未获得锁
<span class="token class-name">Exception</span> in thread <span class="token string">&quot;Thread-1&quot;</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>RuntimeException</span><span class="token operator">:</span> 在等待锁的过程中被打断
    at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>parctice<span class="token punctuation">.</span></span>Practice6</span><span class="token punctuation">.</span>lambda$main$<span class="token function">0</span><span class="token punctuation">(</span><span class="token class-name">Practice6</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">26</span><span class="token punctuation">)</span>
    at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Thread</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">748</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="锁超时" tabindex="-1"><a class="header-anchor" href="#锁超时" aria-hidden="true">#</a> 锁超时</h4><p>如果在一定的时间内没有获得到锁，就不会尝试再获得锁。使用锁超时的API时也可以打断。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Practice7</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LogManager</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">Practice7</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> reentrantLock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        reentrantLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span> thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">//尝试获得锁，如果没有获得到也不等待</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>reentrantLock<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;获得到锁&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                reentrantLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;没有获得到锁&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        thread<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        reentrantLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Practice7</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LogManager</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">Practice7</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> reentrantLock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        reentrantLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span> thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">//尝试获得锁，如果没有获得到等待5s，如果依旧没有获得到就放弃</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>reentrantLock<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;获得到锁&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    reentrantLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
                    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;没有获得到锁&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        thread<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        reentrantLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="公平锁" tabindex="-1"><a class="header-anchor" href="#公平锁" aria-hidden="true">#</a> 公平锁</h4><p>公平锁就是指，在等待锁的线程中，线程获得锁时公平的（先到先得），可以解决线程饥饿问题（线程长时间得不到运行）。</p><p>synchronized是非公平锁，ReentranteLock默认是非公平锁，但可以设置成公平锁。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">//获得公平锁</span>
<span class="token class-name">ReentrantLock</span> reentrantLock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>公平锁一般没有必要，且会降低并发度。</p><h4 id="条件变量" tabindex="-1"><a class="header-anchor" href="#条件变量" aria-hidden="true">#</a> 条件变量</h4><p>ReentrantLock支持多个条件变量。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> reentrantLock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//创建一个新的条件变量</span>
        <span class="token class-name">Condition</span> condition <span class="token operator">=</span> reentrantLock<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        reentrantLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//在条件变量处等待</span>
        condition<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//唤醒一个在条件变量处等待的线程</span>
        condition<span class="token punctuation">.</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//唤醒在条件变量处等待的全部线程</span>
        condition<span class="token punctuation">.</span><span class="token function">signalAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        reentrantLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>使用流程：</p><p>1.使用await前需要获得锁</p><p>2.await后会释放锁，进入conditionObject等待</p><p>3.await的线程被唤醒（或打断、超时）后需要重新争得锁</p><p>4.竞争到锁后，从await后继续执行</p><h2 id="共享模型之内存" tabindex="-1"><a class="header-anchor" href="#共享模型之内存" aria-hidden="true">#</a> 共享模型之内存</h2><h3 id="java内存模型" tabindex="-1"><a class="header-anchor" href="#java内存模型" aria-hidden="true">#</a> Java内存模型</h3><p>Java内存模型，JMM即 Java Memory Model，它定义了主存（所有线程都共享的数据）和工作内存（线程私有的数据）的抽象概念，底层对应着CPU寄存器、缓存、硬件内存、CPU指令优化等。JMM主要是为了屏蔽系统和硬件的差异。</p><p>JMM体现在以下几个方面</p><ul><li><p>原子性-保证指令不会受到线程上下文切换的影响</p></li><li><p>可见性-保证指令不会受cpu缓存的影响</p></li><li><p>有序性-保证指令不会受cpu指令并行优化的影响</p></li></ul><h4 id="可见性" tabindex="-1"><a class="header-anchor" href="#可见性" aria-hidden="true">#</a> 可见性</h4><p>在 JDK1.2 之前，Java 的内存模型实现总是从<strong>主存</strong>（即共享内存）读取变量，是不需要进行特别的注意的。而在当前的 Java 内存模型下，线程可以把变量保存<strong>工作内存（本地内存）</strong> 比如机器的寄存器中，而不是直接在主存中进行读写。这就可能造成一个线程在主存中修改了一个变量的值，而另外一个线程还继续使用它在工作内存中的变量值的拷贝，造成<strong>数据的不一致</strong>。</p><p>把变量声明为 <strong><code>volatile</code></strong> ，这就指示 JVM，这个变量是共享且不稳定的，每次使用它都到主存中进行读取。</p><blockquote><p>Synchronized即可以保证原子性，也可以保证可见性</p></blockquote><h4 id="有序性" tabindex="-1"><a class="header-anchor" href="#有序性" aria-hidden="true">#</a> 有序性</h4><p>JVM会在不影响正确性的前提下，调整语句的执行顺序。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> b <span class="token operator">=</span> <span class="token number">9</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>例如上述代码执行时的真正顺序有可能是先声明赋值b，也有可能是先声明赋值a。</p><p>这种现象是指令重排，是JIT在运行时的一些优化。</p><p>使用volatile关键字可以禁用指令重拍，保证有序性。</p><h3 id="volatile" tabindex="-1"><a class="header-anchor" href="#volatile" aria-hidden="true">#</a> Volatile</h3><p>Volatile关键字可以保证可见性和有序性，但是不能保证指令交错</p><h4 id="volatile原理" tabindex="-1"><a class="header-anchor" href="#volatile原理" aria-hidden="true">#</a> Volatile原理</h4><p>volatile的底层实现原理是内存屏障，Memory Barrier</p><ul><li><p>对volatile变量的写指令后会加入写屏障</p></li><li><p>对volatile变量的读指令前会加入读屏障</p></li></ul><h5 id="保证可见性" tabindex="-1"><a class="header-anchor" href="#保证可见性" aria-hidden="true">#</a> 保证可见性</h5><p>写屏障（sfence）保证在该屏障之前，对共享变量的改动都会同步到主存当中。</p><p>读屏障（lfence）保证在该屏障之后，对共享变量的读取都会加载主存中最新的数据。</p><h5 id="保证有序性" tabindex="-1"><a class="header-anchor" href="#保证有序性" aria-hidden="true">#</a> 保证有序性</h5><p>写屏障会确保指令重拍时，不会将写屏障前的代码排在写屏障之后。</p><p>读屏障会确保指令重拍时，不会讲读屏障后的代码排在读屏障之前。</p><h3 id="cas" tabindex="-1"><a class="header-anchor" href="#cas" aria-hidden="true">#</a> CAS</h3><p>CAS是方法compareAndSet或方法CompareAndSwap的简称，是在CPU层面上实现的原子操作。</p><p>作用是在满足条件时，修改值。compareAndSet(previous, next);当目标值和previous相同时，则修改值为next。若目标值和previous不相同，则修改失败。</p><blockquote><p>其底层使用的是lock cmpxchg指令(X86架构)，单核和多核CPU下都能保证比较和交换值的原子性。</p></blockquote><h2 id="线程池" tabindex="-1"><a class="header-anchor" href="#线程池" aria-hidden="true">#</a> 线程池</h2><h3 id="为什么要使用线程池" tabindex="-1"><a class="header-anchor" href="#为什么要使用线程池" aria-hidden="true">#</a> 为什么要使用线程池</h3><ul><li><strong>降低资源消耗</strong>。通过重复利用已创建的线程降低线程创建和销毁造成的消耗。</li><li><strong>提高响应速度</strong>。当任务到达时，任务可以不需要等到线程创建就能立即执行。</li><li><strong>提高线程的可管理性</strong>。线程是稀缺资源，如果无限制的创建，不仅会消耗系统资源，还会降低系统的稳定性，使用线程池可以进行统一的分配，调优和监控。</li></ul><h3 id="线程池中的线程" tabindex="-1"><a class="header-anchor" href="#线程池中的线程" aria-hidden="true">#</a> 线程池中的线程</h3><p>线程池中的线程分为两种，核心线程和救急线程。当阻塞队列已满且还有新任务到来的情况下，线程池会创建救急线程。救急线程在结束后，会等待一个生存时间，生存时间结束后如果没有任务，救急线程会被结束。核心线程数＋救急线程数=最大线程数。</p><h3 id="创建线程池的方式" tabindex="-1"><a class="header-anchor" href="#创建线程池的方式" aria-hidden="true">#</a> 创建线程池的方式</h3><h4 id="threadpoolexecutor" tabindex="-1"><a class="header-anchor" href="#threadpoolexecutor" aria-hidden="true">#</a> ThreadPoolExecutor</h4><p>可以通过<code>ThreadPoolExecutor</code>构造函数来创建线程池，其构造函数如下。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token keyword">int</span> corePoolSize<span class="token punctuation">,</span>
                              <span class="token keyword">int</span> maximumPoolSize<span class="token punctuation">,</span>
                              <span class="token keyword">long</span> keepAliveTime<span class="token punctuation">,</span>
                              <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">,</span>
                              <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span> workQueue<span class="token punctuation">,</span>
                              <span class="token class-name">ThreadFactory</span> threadFactory<span class="token punctuation">,</span>
                              <span class="token class-name">RejectedExecutionHandler</span> handler<span class="token punctuation">)</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>构造函数参数的解释如下，其中加粗的三项为核心参数：</p><ul><li><p><strong>corePoolSize 核心线程数目 (最多保留的线程数)</strong></p></li><li><p><strong>maximumPoolSize 最大线程数目</strong></p></li><li><p>keepAliveTime 生存时间 - 针对救急线程</p></li><li><p>unit 时间单位 - 针对救急线程</p></li><li><p><strong>workQueue 阻塞队列</strong></p><p>核心线程用完了，再加入的任务，首先就会加入到阻塞队列中</p></li><li><p>threadFactory 线程工厂</p><p>可以为线程创建时起个好名字</p></li><li><p>handler 拒绝策略</p></li></ul><h4 id="executors" tabindex="-1"><a class="header-anchor" href="#executors" aria-hidden="true">#</a> Executors</h4><p>还可以通过 <code>Executor</code> 框架的工具类 <code>Executors</code> 来创建线程池。</p><blockquote><p>另外，《阿里巴巴 Java 开发手册》中强制线程池不允许使用 <code>Executors</code> 去创建，而是通过 <code>ThreadPoolExecutor</code> 构造函数的方式，这样的处理方式让写的同学更加明确线程池的运行规则，规避资源耗尽的风险。</p></blockquote><p>通过<code>Executors</code>可以创建多种类型的<code>ThreadPoolExecutor</code>:</p><ul><li><strong><code>FixedThreadPool</code></strong>：该方法返回一个固定线程数量的线程池。该线程池中的线程数量始终不变。当有一个新的任务提交时，线程池中若有空闲线程，则立即执行。若没有，则新的任务会被暂存在一个任务队列中，待有线程空闲时，便处理在任务队列中的任务。</li><li><strong><code>SingleThreadExecutor</code>：</strong> 该方法返回一个只有一个线程的线程池。若多余一个任务被提交到该线程池，任务会被保存在一个任务队列中，待线程空闲，按先入先出的顺序执行队列中的任务。</li><li><strong><code>CachedThreadPool</code>：</strong> 该方法返回一个可根据实际情况调整线程数量的线程池。线程池的线程数量不确定，但若有空闲线程可以复用，则会优先使用可复用的线程。若所有线程均在工作，又有新的任务提交，则会创建新的线程处理任务。所有线程在当前任务执行完毕后，将返回线程池进行复用。</li><li><strong><code>ScheduledThreadPool</code></strong>：该返回一个用来在给定的延迟后运行任务或者定期执行任务的线程池。</li></ul><h3 id="线程池状态" tabindex="-1"><a class="header-anchor" href="#线程池状态" aria-hidden="true">#</a> 线程池状态</h3><p>ThreadPoolExecutor 使用 int 的高 3 位来表示线程池状态，低 29 位表示线程数量</p><table><thead><tr><th>状态名</th><th>高 3位</th><th>接收新任务</th><th>处理阻塞队列任务</th><th>说明</th></tr></thead><tbody><tr><td>RUNNING</td><td>111</td><td>Y</td><td>Y</td><td></td></tr><tr><td>SHUTDOWN</td><td>000</td><td>N</td><td>Y</td><td>不会接收新任务，但会处理阻塞队列剩余任务</td></tr><tr><td>STOP</td><td>001</td><td>N</td><td>N</td><td>会中断正在执行的任务，并抛弃阻塞队列任务</td></tr><tr><td>TIDYING</td><td>010</td><td></td><td></td><td>任务全执行完毕，活动线程为 0 即将进入终结</td></tr><tr><td>TERMINATED</td><td>011</td><td></td><td></td><td>终结状态</td></tr></tbody></table><p>从数字上比较，TERMINATED &gt; TIDYING &gt; STOP &gt; SHUTDOWN &gt; RUNNING</p><p>这些信息存储在一个原子变量 ctl 中，目的是将线程池状态与线程个数合二为一，这样就可以用一次 cas 原子操作进行赋值</p><h3 id="线程池的饱和策略" tabindex="-1"><a class="header-anchor" href="#线程池的饱和策略" aria-hidden="true">#</a> 线程池的饱和策略</h3><p>如果当前同时运行的线程数量达到最大线程数量并且队列也已经被放满了任务时，<code>ThreadPoolTaskExecutor</code> 定义一些策略:</p><ul><li><strong><code>ThreadPoolExecutor.AbortPolicy</code>：</strong> 抛出 <code>RejectedExecutionException</code>来拒绝新任务的处理。</li><li><strong><code>ThreadPoolExecutor.CallerRunsPolicy</code>：</strong> 调用执行自己的线程运行任务，也就是直接在调用<code>execute</code>方法的线程中运行(<code>run</code>)被拒绝的任务，如果执行程序已关闭，则会丢弃该任务。因此这种策略会降低对于新任务提交速度，影响程序的整体性能。如果您的应用程序可以承受此延迟并且你要求任何一个任务请求都要被执行的话，你可以选择这个策略。</li><li><strong><code>ThreadPoolExecutor.DiscardPolicy</code>：</strong> 不处理新任务，直接丢弃掉。</li><li><strong><code>ThreadPoolExecutor.DiscardOldestPolicy</code>：</strong> 此策略将丢弃最早的未处理的任务请求。</li></ul><h3 id="线程池的任务处理流程" tabindex="-1"><a class="header-anchor" href="#线程池的任务处理流程" aria-hidden="true">#</a> 线程池的任务处理流程</h3><figure><img src="/assets/2023-05-15-10-56-36-图解线程池实现原理-29b32c83.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ol><li>如果当前运行的线程数小于核心线程数，那么就会新建一个线程来执行任务。</li><li>如果当前运行的线程数等于或大于核心线程数，但是小于最大线程数，那么就把该任务放入到任务队列里等待执行。</li><li>如果向任务队列投放任务失败（任务队列已经满了），但是当前运行的线程数是小于最大线程数的，就新建一个线程来执行任务。</li><li>如果当前运行的线程数已经等同于最大线程数了，新建线程将会使当前运行的线程超出最大线程数，那么当前任务会被拒绝，饱和策略会调用<code>RejectedExecutionHandler.rejectedExecution()</code>方法。</li></ol><h2 id="threadlocal" tabindex="-1"><a class="header-anchor" href="#threadlocal" aria-hidden="true">#</a> ThreadLocal</h2><p>ThreadLocal叫做线程变量、线程本地变量，意思是ThreadLocal中填充的变量属于当前线程，该变量对其他线程而言是隔离的，也就是说该变量是当前线程独有的变量。ThreadLocal为变量在每个线程中都创建了一个副本，那么每个线程可以访问自己内部的副本变量。对于ThreadLocal变量，每个线程都使用 <code>get()</code> 和 <code>set()</code> 方法来获取或修改其中存放的值，从而避免了线程安全问题。</p><h3 id="原理" tabindex="-1"><a class="header-anchor" href="#原理" aria-hidden="true">#</a> 原理</h3><p>每个线程都拥有一个自己的<strong>ThreadLocalMap</strong>。ThreadLockMap中会存储<strong>以ThreadLock对象为Key，ThreadLocal中的变量为Value的键值对</strong>。</p><h3 id="threadlocal的内存泄露风险" tabindex="-1"><a class="header-anchor" href="#threadlocal的内存泄露风险" aria-hidden="true">#</a> ThreadLocal的内存泄露风险</h3><p><code>ThreadLocalMap</code> 中使用的 key 为 <code>ThreadLocal</code> 的弱引用，而 value 是强引用。所以，如果 <code>ThreadLocal</code> 没有被外部强引用的情况下，在垃圾回收的时候，key 会被清理掉，而 value 不会被清理掉。</p><blockquote><p>弱引用也是用来描述那些非必须对象，但是它的强度比软引用更弱一些，被弱引用关联的对象只能生存到下一次垃圾收集发生为止。当垃圾收集器开始工作，无论当前内存是否足够，都会回收掉只被弱引用关联的对象。</p></blockquote><p>这样一来，<code>ThreadLocalMap</code> 中就会出现 key 为 null 的 Entry。假如我们不做任何措施的话，value 永远无法被 GC 回收，这个时候就可能会产生内存泄露。<code>ThreadLocalMap</code> 实现中已经考虑了这种情况，在调用 <code>set()</code>、<code>get()</code>、<code>remove()</code> 方法的时候，会清理掉 key 为 null 的记录。使用完 <code>ThreadLocal</code>方法后最好手动调用<code>remove()</code>方法</p><h3 id="使用场景" tabindex="-1"><a class="header-anchor" href="#使用场景" aria-hidden="true">#</a> 使用场景</h3><p>存储系统当前的登录用户信息是ThreadLocal的一个很常见的用户场景，使用示例如下。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 当前登录用户身份存储
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserInfoHolder</span> <span class="token punctuation">{</span>
    <span class="token doc-comment comment">/**
     * 用户信息存储ThreadLocal
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserInfoBO</span><span class="token punctuation">&gt;</span></span> userInfoStorage <span class="token operator">=</span> <span class="token class-name">ThreadLocal</span><span class="token punctuation">.</span><span class="token function">withInitial</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 设置用户身份信息
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">UserInfoBO</span> userInfoBO<span class="token punctuation">)</span><span class="token punctuation">{</span>
        userInfoStorage<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>userInfoBO<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 获得当前登录的用户身份信息
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">UserInfoBO</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> userInfoStorage<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 移除线程中的登录用户信息
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        userInfoStorage<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="aqs" tabindex="-1"><a class="header-anchor" href="#aqs" aria-hidden="true">#</a> AQS</h2><p>AbstractQueuedSynchronizer 是阻塞式锁和相关的同步器工具的框架。</p><p>特点：</p><p>用state属性来表示资源的状态，分为独占模式和共享模式。子类需要定义如何维护这个状态，控制如何获取和释放锁。</p><p>提供基于FIFO的等待队列，类似于Monitor的EntryList</p><p>条件变量实现等待、唤醒机制，支持多个条件变量</p></div><!----><footer class="page-meta"><!----><div class="meta-item git-info"><!----><!----></div></footer><!----><!----><!----><!--]--></main><!--]--><footer class="footer-wrapper"><div class="footer">页面到这里就停止了，但世界依旧在不断前行</div><div class="copyright">Copyright © 2023 Mr.Bai</div></footer></div><!--]--><!----><!----><!--]--></div>
    <script type="module" src="/assets/app-96b52a23.js" defer></script>
  </body>
</html>
